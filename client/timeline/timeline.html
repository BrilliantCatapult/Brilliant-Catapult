<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="d3sliderstyle.css">
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="../dockRoutes/dockRoutesObj.js"></script>
  <script src="../js/buildgeojson.js"></script>
  <script src="d3slider.js"></script>
</head>
<body>
  <div id="buttons">
    <button id="playbutton">Play</button>
  </div>
  <div id="slider"></div>

  <script>
    var zeroBug = 0.000001;
    var sliderValue = zeroBug;
    var play = false;
    var mins = 0;
    var hours = 0;
    var dbJson;
    // var tripCount = 0;
    var tripHash = {};
    


    d3.json("/api/timeline", function(error, json) {
      if (error) {
        console.log("error", error);
      }
      console.log("successsssss--------->", json);
      dbJson = parseDBJson(json);
      calcEvents();


    });

    var slider = d3.slider().axis(d3.svg.axis().ticks(24)).max(24).animate(500).value(zeroBug);
    d3.select('#slider').call(slider);
    
    var animate = function(){
      if (play){
        var currentTime = countTime();
        if (currentTime[1] === "00") {
          console.log(currentTime, sliderValue, "--->wut")
          if (sliderValue === 24) {
            sliderValue = zeroBug;
          }
          else {
            sliderValue++;
            if (sliderValue === 1 + zeroBug) sliderValue = 1;
          }
          slider.value(sliderValue)
        }
        currentTime = currentTime.join(":");
        var newTrip = checkForTrip(currentTime);

        if (newTrip.features.length) {
          drawTrip(newTrip);
        }

        d3.timer(animate, 37);
      }
      return true;
    }

    var button = d3.select("#playbutton");
    button.on("click", function(){
      play = !play;
      animate();
    });

    var countTime = function(){
      var countHours, countMins;
      mins++
      if (mins === 60) {
        hours++;
        mins = 0;
        if (hours === 24){
          hours = 0;
        }
      }

      countHours = hours;

      if (mins < 10) {
        countMins = "0" + mins;
      }
      else {
        countMins = ""+ mins;
      }
      return [countHours, countMins];
    };

    var checkForTrip = function(time) {
      var trip = {
        "type": "FeatureCollection",
        "features": []
      };

      if (tripHash[time]["startingTrips"].length) {
        for (var i = 0; i < tripHash[time]["startingTrips"].length; i++) {
          trip.features.push(dbJson.features[tripHash[time]["startingTrips"][i]]);
        }
      }

      // while (dbJson.features[tripCount]["properties"]["startTime"] === time){
      //   trip.features.push(dbJson.features[tripCount]);
      //   tripCount++;

      //   if (tripCount === dbJson.features.length){
      //     tripCount = 0;
      //   }
      // }
      return trip;
    };

    var calcEvents = function(){
      for (var i = 0; i < 1440; i++){
          var time = countTime().join(":");
          tripHash[time] = {"currentTrips": [], "startingTrips": []};
      }
      mins = 0;
      hours = 0;

      for (var i = 0; i < dbJson.features.length; i++){
        var startTime = dbJson.features[i]["properties"]["startTime"];
        var endTime = dbJson.features[i]["properties"]["endTime"];
        var splitStartTime = startTime.split(":");
        var splitEndTime = endTime.split(":");
        hours = splitStartTime[0];
        mins = splitStartTime[1];

        tripHash[startTime]["startingTrips"].push(i);

        // console.log(splitStartTime, splitEndTime);
        // console.log("hours and mins ", hours, mins);

        for (var h = splitStartTime[0], m = splitStartTime[1]; m < splitEndTime[1] && h <= splitEndTime[0]; h = hours, m = mins) {
          tempTime = h + ":" + m;
          // console.log("tempTime", tempTime);
          // var tempTime = countTime().join(":");
          // console.log(tempTime);
          tripHash[tempTime]["currentTrips"].push(i);
          mins = countTime()[1];
          // console.log("new hours and mins ", hours, mins);
        }
      }
      mins = 0;
      hours = 0;

      console.log(tripHash);
    };
    // setTimeout(function() {calcEvents()}, 7000);
    

    var width = Math.max(960, window.innerWidth),
      height = Math.max(500, window.innerHeight);

    var projection = d3.geo.mercator()
      .scale((1 << 21) / 2 / Math.PI)
      .translate([-width / 2, -height / 2]);

    var path = d3.geo.path()
      .projection(projection);

    var zoom = d3.behavior.zoom()
      .scale(projection.scale() * 2 * Math.PI)
      .scaleExtent([1 << 20, 1 << 23])
      .translate(projection([-122.4, 37.7782]).map(function(x) {
        console.log('zoom', x);
        return -x;
      }));

    var map = d3.select("body").append("div")
      .attr("class", "map")
      .style("width", width + "px")
      .style("height", height + "px")
      .call(zoom);

    var svgPoints = map.append("svg:svg")
      .attr("class", 'points')
      .style("width", width + "px")
      .style("height", height + "px")
      .call(zoom);

    projection
      .scale(zoom.scale() / 2 / Math.PI)
      .translate(zoom.translate());

    var drawTrip = function(trips) {
      /////// ADD IN RENDER CODE
      var pathNode = svgPoints.append("svg:g")
        .selectAll("path")
        .data(trips.features)
        .enter()
        .append("svg:g")
        .attr("class", "route")
        .append("svg:path")
        .attr("d", path)
        .attr("fill-opacity", 0)
        .attr("stroke", "#333");

      var circle = svgPoints.selectAll(".route")
        .append("circle")
        .attr("r", 10)
        .attr("fill", '#f33')
        .transition()
        .duration(10000)
        .ease("linear")
        .attrTween("transform", function(d, i) {
          var thePath = d3.select(this.parentNode).select("path").node();
          // console.log(thePath);
          return function(t) {
            var p = thePath.getPointAtLength(thePath.getTotalLength() * t);
            return "translate(" + [p.x, p.y] + ")";
          }
        });
    }
  </script>
</body>
</html>