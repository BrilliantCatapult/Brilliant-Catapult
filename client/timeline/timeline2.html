<!DOCTYPE html>
<html>

<head>
  <title></title>
  <meta charset="utf-8">
  <script src="../dockRoutes/dockRoutesObj.js"></script>
  <script src="../js/buildgeojson.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
</head>

<body>
  <div id="buttons">
    <button id="playbutton">Play</button>
  </div>
  <div id="slider"></div>
  <script>
  var width = window.innerWidth - 50;
  var height = Math.max(500, window.innerHeight);

  var second = 1000;
  var minute = 60 * second;
  var hour = 60 * minute;
  var day = 24 * hour;

  var dbJson;
  var play = false;
  var realTimeFormat;
  var timer, timermemo = 0;
  var realtime;
  var circles = [];

  var animduration = 5 * minute;

  var timescale = d3.time.scale()
    .domain([new Date, new Date])
    .nice(d3.time.day)
    .range([0, width]);

  var animscale = d3.scale.linear()
    .domain([0, animduration])
    .range([0, width]);

  var axis = d3.svg.axis()
    .scale(timescale)
    .ticks(24)
    .tickFormat(d3.time.format("%H"));

  var formatMilliseconds = function(d) {
    var hours = Math.floor(d / hour);
    var minutes = Math.floor((d % hour) / minute);
    if (minutes < 10) {
      minutes = "0" + minutes;
    }
    return hours + ":" + minutes;
  };

  var timeToMilliSeconds = function(string) {
    var values = string.split(":");
    return values[0] * hour + values[1] * minute;
  };

  var projection = d3.geo.mercator()
    .scale((1 << 21) / 2 / Math.PI)
    .translate([-width / 2, -height / 2]);

  var path = d3.geo.path()
    .projection(projection);

  var zoom = d3.behavior.zoom()
    .scale(projection.scale() * 2 * Math.PI)
    .scaleExtent([1 << 20, 1 << 23])
    .translate(projection([-122.4, 37.7782]).map(function(x) {
      console.log('zoom', x);
      return -x;
    }));

  var svgTimeline = d3.select("body").append("svg")
    .attr("width", width);

  svgTimeline.append("g")
    .attr("transform", "translate(5,0)")
    .call(axis);

  var cursor = svgTimeline.append("circle")
    .attr('r', 8)
    .attr("fill", "red")
    .attr("id", "cursor");

  var map = d3.select("body").append("div")
    .attr("class", "map")
    .style("width", width + "px")
    .style("height", height + "px")
    .call(zoom);

  var svgBikeRoutes = map.append("svg:svg")
    .attr("class", 'points')
    .style("width", width + "px")
    .style("height", height + "px")
    .call(zoom);

  projection
    .scale(zoom.scale() / 2 / Math.PI)
    .translate(zoom.translate());

  d3.json("/api/timeline", function(error, json) {
    if (error) {
      console.log("error", error);
    }
    dbJson = parseDBJson(json);
    console.log("successsssss--------->", dbJson);
    drawTrip(dbJson);
  });

  var animate = function(e) {
    if (!play) {
      timermemo = timer;
      return true;
    }
    timer = (timermemo + e) % animduration;
    realtime = timer * day / animduration;
    realTimeFormat = formatMilliseconds(realtime);
    
    // console.log("timer", realTimeFormat, timer);

    cursor.attr("transform", function(d) {
      return "translate(" + animscale(timer) + ")";
    });

    for (var i = 0; i < circles[0].length; i++) {
      d3.select(circles[0][i]).attr("transform", function(d) {
        var thePath = d3.select(this.parentNode).select("path").node();
        var startTime = timeToMilliSeconds(d.properties.startTime);
        var endTime = timeToMilliSeconds(d.properties.endTime);

        if (realtime - startTime > 0 && endTime - realtime > 0) {
          var p = thePath.getPointAtLength(thePath.getTotalLength() * (realtime - startTime) / (endTime - startTime));
          return "translate(" + [p.x, p.y] + ")";
        }
      });
    }
  };

  var button = d3.select("#playbutton");
  button.on("click", function() {
    play = !play;
    if (play) {
      d3.timer(animate);
    }
  });

  var drawTrip = function(trips) {
    var routes = svgBikeRoutes.append("svg:g")
      .selectAll("path")
      .data(trips.features)
      .enter()
      .append("svg:g")
      .attr("class", "route")
      .append("svg:path")
      .attr("d", path)
      .attr("fill-opacity", 0)
      .attr("stroke", "#333");

    circles = svgBikeRoutes.selectAll(".route")
      .append("circle")
      .attr("r", 10)
      .attr("fill", '#f33');
  }
  </script>
</body>

</html>
